$def with(plugin_options, events, stat)

$var title: $_('System update from GitHub')
$var page: plugins

<style>
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.switch::before {
  position: absolute;
  left: -40px;
  top: 50%;
  transform: translateY(-50%);
  color: red;
  font-weight: bold;
}

.switch::after {
  position: absolute;
  right: -40px;
  top: 50%;
  transform: translateY(-50%);
  color: green;
  font-weight: bold;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: red;
  transition: 0.4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: green;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.switch {
  display: inline-block;
}

.switch input {
  display: none;
}

table.optionList {
   width: 92%;  
}

#controls {
  width: 78%;
  border: 3px solid #2E3959;
  border-radius: 10px;
  padding: 10px;
  margin-top: 10px;
}

#controls .button:hover,
#controls .submit:hover {
  background-color: #007bff;
  color: white;
}

#controls select {
  width: 90%;            
  white-space: normal;      
  overflow-wrap: anywhere; 
  border-radius: 6px;
  padding: 4px;
}

.status-area {
  font-family: monospace;
  width: 95%;
  box-sizing: border-box;
  border: 1px solid ;
  border-radius: 6px;
  background-color: #f8faff;
  padding: 6px;
  resize: vertical;
}

.section-box {
  width: 90%;
  border: 3px solid #2E3959;
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
}

.commit-list {
  max-height: 300px;
  overflow-y: auto;
  border-radius: 6px;
  background-color: #ffffff;
  padding: 8px;
}

.commit-item {
  display: flex;
  align-items: flex-start;
  padding: 6px;
  margin-bottom: 6px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.commit-item:hover {
  background-color: #e6f0ff;
}

.commit-item input[type="radio"] {
  margin-right: 10px;
  margin-top: 4px;
}

.commit-info {
  flex: 1;
  word-break: break-word;
  white-space: normal;
}

.commit-header {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  color: #004a9f;
}

.commit-date {
  font-size: 0.9em;
}

.commit-hash {
  font-size: 0.9em;
  color: #555;
  font-family: monospace;
}

.commit-message {
  margin-top: 3px;
  font-size: 0.9em;
  white-space: normal;
}

.commit-actions {
  text-align: center;
  margin-top: 10px;
}
</style>

<script>
jQuery(document).ready(function(){
    jQuery("#cSubmit").click(function() {
        jQuery("#pluginForm").submit();
    });
    jQuery("button#cCancel").click(function(){
        window.location="/";
    });
    jQuery("#rollbackForm").submit(function(e){
        let selected = jQuery('input[name="commit_hash"]:checked').val();
        if(!selected){
            alert("$_('Please select a version to rollback to!')");
            e.preventDefault();
            return false;
        }
        if(!confirm("$_('Are you sure you want to rollback to commit') " + selected + "?$_('All local changes will be lost!')")){
            e.preventDefault();
            return false;
        }
    });
});
</script>

<div id="plugin">
    <div class="title">$_('System update from GitHub')</div>
    <a href=$plugins.plugin_url('system_update.help_page') class="button upload">$_('Help')</a><br/>
    <form id="pluginForm" method="post">
        <table class="optionList">
            <tr>
                <td style='text-transform: none;'>$_('Use update plugin'):</td>
                <td title=$:{json.dumps(_('If the check box is selected, the plugin will be active.'), ensure_ascii=False)}>
                <label class="switch">
                <input name='use_update' type='checkbox'${" checked" if plugin_options['use_update'] else ""}>
                <span class="slider"></span>
                </label>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'><b>$_('Remote repository'):</b></td>
                <td>
                    $stat["remote"]
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'><b>$_('Remote branch'):</b></td>
                <td>
                    $stat["remote_branch"]
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'><b>$_('Local OSPy version'):</b></td>
                <td>
                    $stat["ver_str"]
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'><b>$_('Local OSPy date'):</b></td>
                <td>
                    $stat["ver_date"]
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'><b>$_('Current commit hash'):</b></td>
                <td>
                    $stat["local_hash"]
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Automatic update'):</td>
                <td title=$:{json.dumps(_('If the check box is selected, the plug-in updates the system OSPy itself.'), ensure_ascii=False)}>
                <label class="switch">
                <input name='auto_update' type='checkbox'${" checked" if plugin_options['auto_update'] else ""}>
                <span class="slider"></span>
                </label>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Send E-mail if update is available'):</td>
                <td title=$:{json.dumps(_('If checked, extension will send an e-mail notifying you when a new version is available. For this function required e-mail plugin.'), ensure_ascii=False)}>
                <label class="switch">
                <input name='use_eml' type='checkbox'${" checked" if plugin_options['use_eml'] else ""}>
                <span class="slider"></span>
                </label>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('E-mail subject'):</td>
                <td>
                    <input name='eml_subject' type='text' value='$plugin_options["eml_subject"]'>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('E-mail plug-ins'):</td>
                <td title=$:{json.dumps(_('Select E-mail plug-in for sending E-mail'), ensure_ascii=False)}>
                <select name="eplug">
                    <option value="0" ${"selected" if plugin_options["eplug"]==0 else ""}>$_('E-mail notifications V1')</option>
                    <option value="1" ${"selected" if plugin_options["eplug"]==1 else ""}>$_('E-mail notifications V2 SSL')</option>
                </select>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Show in footer'):</td>
                <td title=$:{json.dumps(_('Show data from plugin in footer on home page'), ensure_ascii=False)}>
                <label class="switch">
                <input name='use_footer' type='checkbox'${" checked" if plugin_options['use_footer'] else ""}>
                <span class="slider"></span>
                </label>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <button id="cSubmit" class="submit"><b>$_('Save changes')</b></button>
                    <a href="$plugins.plugin_url('system_update.restart_page')" class="button reboot danger">$_('Restart OSPy software')</a>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Status'):</td>
                <td>
                    <textarea class="status-area" rows="25" cols="55" readonly>$'\n'.join(events)</textarea><br/>
                    <a href="$plugins.plugin_url('system_update.status_page')" class="button refresh">$_('Check new version')</a>
                    $if stat['can_update']:
                        <a href="$plugins.plugin_url('system_update.update_page')" class="button reboot danger"><b>$_('A new version of OSPy is available - update?')</b></a>
                    $if stat['can_error']:
                        <a href="$plugins.plugin_url('system_update.error_page')" class="button upload danger"><b>$_('Fix detected dubious ownership?')</b></a>                        
                </td>
            </tr>
        </table>
    </form>
</div>

<!-- Rollback Section -->
<div class="section-box">
  <h3>$_('Rollback to previous version')</h3>
  <form id="rollbackForm" method="POST" action="$plugins.plugin_url('system_update.rollback_select_page')">
    <div id="commitList" class="commit-list">
      $for c in stat["commits"]:
        <label class="commit-item">
          <input type="radio" name="commit_hash" value="$c['hash']">
          <div class="commit-info">
            <div class="commit-header">
              <span class="commit-date">$c['date']</span>
              <span class="commit-hash">$c['hash']</span>
            </div>
            <div class="commit-message">$c['message']</div>
          </div>
        </label>
    </div>

    <div class="commit-actions">
      <button type="submit" id="rollbackButton" class="button reboot danger">$_('Rollback to selected version')</button>
    </div>
  </form>
</div>

<button id="cCancel" class="cancel danger">$_('Cancel')</button>