$def with(plugin_options, events, state)

$var title: $_('Network Ping monitor - settings')
$var page: plugins

<style>
.status-connected {
    color: #28a745;
    font-weight: bold;
}

.status-disconnected {
    color: #dc3545;
    font-weight: bold;
}

.status-disabled {
    color: #FFCC00;
    font-weight: bold;
}

#Message {
    color: blue;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.switch::before {
  position: absolute;
  left: -40px;
  top: 50%;
  transform: translateY(-50%);
  color: red;
  font-weight: bold;
}

.switch::after {
  position: absolute;
  right: -40px;
  top: 50%;
  transform: translateY(-50%);
  color: green;
  font-weight: bold;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: red;
  transition: 0.4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: green;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.switch {
  display: inline-block;
}

.switch input {
  display: none;
}
</style>

<script>
const i18n = {
  connected: $:{json.dumps(_('Connected'), ensure_ascii=False).encode('utf8').decode('utf-8')},
  disconnected: $:{json.dumps(_('Disconnected'), ensure_ascii=False).encode('utf8').decode('utf-8')},
  not_loaded: $:{json.dumps(_('Not yet loaded'), ensure_ascii=False).encode('utf8').decode('utf-8')},
  disabled: $:{json.dumps(_('Disabled'), ensure_ascii=False).encode('utf8').decode('utf-8')},
  ms: $:{json.dumps(_('ms'), ensure_ascii=False).encode('utf8').decode('utf-8')}
};

jQuery(document).ready(function() {
    jQuery("#cSubmit").click(function() {
        jQuery("#pluginForm").submit();
    });
    jQuery("button#cCancel").click(function() {
        window.location = "/";
    });

    // Auto-refresh každých 5 sekund
    setInterval(updatePingStates, 5000);
});

function updatePingStates() {
    jQuery.getJSON("/plugins/network_ping_monitor/data_json", function(data) {
        if (data.error) return;

        // Aktualizace stavů pingů
        updatePingState(1, data.ping1, data.rtt1, data.use_ping);
        updatePingState(2, data.ping2, data.rtt2, data.use_ping);
        updatePingState(3, data.ping3, data.rtt3, data.use_ping);

        // Aktualizace log textarea
        if (data.events) {
            jQuery("textarea[readonly]").val(data.events.join("\n"));
        }
    });
}

function updatePingState(num, pingState, rtt, use_ping) {
    const el = jQuery("#ping_state_" + num);
    if (!use_ping) {
        el.html('<span class="status-disabled">' + i18n.disabled + '</span>');
        return;
    }
    if (pingState === null) {
        el.html('<span class="status-disconnected">' + i18n.not_loaded + '</span>');
    } else if (pingState) {
        el.html('<span class="status-connected">' + i18n.connected + ' (' + rtt + ' ' + i18n.ms + ')</span>');
    } else {
        el.html('<span class="status-disconnected">' + i18n.disconnected + '</span>');
    }
}
</script>

<div id="plugin">
    <div class="title">$_('Network Ping monitor - settings')</div>
    <a href=$plugins.plugin_url('network_ping_monitor.help_page') class="button upload">$_('Help')</a>
    $if plugin_options['enable_log'] or plugin_options['en_sql_log']:
        <p>
        <a href="$plugins.plugin_url('network_ping_monitor.log_page')" class="button backup">$_('Show logs')</a>
        <a href="$plugins.plugin_url('network_ping_monitor.graph_page')" class="button backup">$_('Show graph')</a>
        </p>
        </br>     
    <form id="pluginForm" action="$plugins.plugin_url('network_ping_monitor.settings_page')" method="post">
        <table class="optionList">
            <tr>
                <td style='text-transform: none;'>$_('Use ping monitoring'):</td>
                <td title=$:{json.dumps(_('Activate this extension use for ping testing.'), ensure_ascii=False)}>
                <label class="switch">
                <input name='use_ping' type='checkbox'${" checked" if plugin_options['use_ping'] else ""}>
                <span class="slider"></span>
                </label>
                </td>
            </tr>
            <tr>
                <td></td>
                <td style='text-transform: none;'>$_('IP address')</td>
                <td style='text-transform: none;'>$_('Label')</td>
                <td style='text-transform: none;'>$_('State')</td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Ping address 1'):</td>
                <td><input name='address_1' type='text' value='$plugin_options['address_1']'></td>
                <td><input name='label_1' type='text' value='$plugin_options['label_1']'></td>
                <td id="ping_state_1">
                $if plugin_options['use_ping']:
                    $if state["ping1"] is None:
                        <span class="status-disconnected">$_('Not yet loaded')</span>
                    $else:
                        $if state["ping1"]:
                            <span class="status-connected">$_('Connected') ($state["rtt1"] $_('ms'))</span>
                        $else:
                            <span class="status-disconnected">$_('Disconnected')</span>
                $else:
                    <span class="status-disabled">$_('Disabled')</span>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Ping address 2'):</td>
                <td><input name='address_2' type='text' value='$plugin_options['address_2']'></td>
                <td><input name='label_2' type='text' value='$plugin_options['label_2']'></td> 
                <td id="ping_state_2">
                $if plugin_options['use_ping']:
                    $if state["ping2"] is None:
                        <span class="status-disconnected">$_('Not yet loaded')</span>
                    $else:
                        $if state["ping2"]:
                            <span class="status-connected">$_('Connected') ($state["rtt2"] $_('ms'))</span>
                        $else:
                            <span class="status-disconnected">$_('Disconnected')</span>
                $else:
                    <span class="status-disabled">$_('Disabled')</span>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Ping address 3'):</td>
                <td><input name='address_3' type='text' value='$plugin_options['address_3']'></td>
                <td><input name='label_3' type='text' value='$plugin_options['label_3']'></td>
                <td id="ping_state_3">
                $if plugin_options['use_ping']:
                    $if state["ping3"] is None:
                        <span class="status-disconnected">$_('Not yet loaded')</span>
                    $else:
                        $if state["ping3"]:
                            <span class="status-connected">$_('Connected') ($state["rtt3"] $_('ms'))</span>
                        $else:
                            <span class="status-disconnected">$_('Disconnected')</span>
                $else:
                    <span class="status-disabled">$_('Disabled')</span>
                </td>
            </tr>
            <tr>
               <th colspan="4">
                 <hr>
               </th>
            </tr>            
            <tr>
                <td style='text-transform: none;'>$_('Enable local logging'):</td>
                <td title=$:{json.dumps(_('The measured data will be saved locally in a json file. This option rapidly reduces the lifespan of the SD/USB card of the Raspberry Pi system!'), ensure_ascii=False)}>
                    <label class="switch">
                    <input name='enable_log' type='checkbox'${" checked" if plugin_options['enable_log'] else ""}>
                    <span class="slider"></span>
                    </label>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Enable SQL logging'):</td>
                <td title=$:{json.dumps(_('The measured data will be stored in the database. This option requires the database connector extension to be installed and configured. The button will delete the netping table from the database, thus deleting all saved data from this extension! This promotion is non-refundable! Requires database connector plugin'), ensure_ascii=False)}>
                    <label class="switch"> 
                    <input name='en_sql_log' type='checkbox'${" checked" if plugin_options['en_sql_log'] else ""}>
                    <span class="slider"></span>
                    </label>
                </td>
                <td>
                    <a href="?delSQL" class="button cancel danger">$_('Delete SQL table')</a>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Logging all errors'):</td>
                <td title=$:{json.dumps(_('If this option is checked, all outages will be saved in the logs. Otherwise, only outages and restarts of all 3 servers will be saved.'), ensure_ascii=False)}>
                    <label class="switch">
                    <input name='log_all_servers' type='checkbox'${" checked" if plugin_options['log_all_servers'] else ""}>
                    <span class="slider"></span>
                    </label>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Show data from'):</td>
                <td>
                    <select id="type_log" name="type_log" style="width: 200px" title=$:{json.dumps(_('Choose from where the displayed data in the log and graph will be loaded.'), ensure_ascii=False)}>
                    <option value="0" ${"selected" if plugin_options['type_log']==0 else ""}>$_('Local file')</option>
                    <option value="1" ${"selected" if plugin_options['type_log']==1 else ""}>$_('Database file')</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Maximum number of log records'):</td>
                <td title=$:{json.dumps(_('The maximum number of records sets the number of saved records, i.e. after exceeding the set limit, older data is overwritten. 0 = unlimited. The maximum number is only for local storage (not for database).'), ensure_ascii=False)}>
                    <input name='log_records' type='number' min='0' value='$plugin_options["log_records"]'>
                </td>
            </tr>
            <tr>
                <td style='text-transform: none;'>$_('Interval for logging'):</td>
                <td title=$:{json.dumps(_('The logging interval is common for both local storage and sql storage of measured data. minutes (Minimum is 1)'), ensure_ascii=False)}>
                    <input name='log_interval' type='number' min='1' value='$plugin_options["log_interval"]'>
                </td>
            </tr>            
            <tr>
                <td style='text-transform: none;'>$_('Status'):</td>
                <td colspan="3">
                    <textarea style="font-family: monospace;" rows="7" cols="70" readonly>$'\n'.join(events)</textarea>
                </td>
            </tr>
        </table>
    </form>
</div>
<div id="controls">
    <button id="cSubmit" class="submit"><b>$_('Submit')</b></button>
    <button id="cCancel" class="cancel danger">$_('Cancel')</button>
</div>